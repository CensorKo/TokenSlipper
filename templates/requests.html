{% extends "base.html" %}

{% block title %}è¯·æ±‚åˆ—è¡¨ - TokenSlipper ç®¡ç†åå°{% endblock %}

{% block extra_css %}
<style>
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .page-size-selector {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .page-size-selector label {
        font-size: 14px;
        color: #666;
    }
    
    .page-size-selector select {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        background: white;
    }
    
    .page-size-selector select:hover {
        border-color: #667eea;
    }
    
    .stats-info {
        font-size: 14px;
        color: #666;
    }
    
    .stats-info strong {
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>ğŸ“‹ æ‰€æœ‰è¯·æ±‚</h2>
    </div>
    <div class="card-body">
        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <div class="page-size-selector">
                <label for="pageSize">æ¯é¡µæ˜¾ç¤º:</label>
                <select id="pageSize" onchange="changePageSize(this.value)">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10 æ¡</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20 æ¡</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 æ¡</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 æ¡</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200 æ¡</option>
                </select>
            </div>
            <div class="stats-info">
                å…± <strong>{{ total }}</strong> æ¡è®°å½• | 
                ç¬¬ <strong>{{ page }}</strong> / <strong>{{ total_pages }}</strong> é¡µ
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>æ—¶é—´</th>
                    <th>è¯·æ±‚æ¨¡å‹</th>
                    <th>å®é™…æ¨¡å‹</th>
                    <th>æ¶ˆæ¯æ•°</th>
                    <th>Temperature</th>
                    <th>Stream</th>
                    <th>Tokens</th>
                    <th>è€—æ—¶</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                <tr>
                    <td class="text-small">#{{ req.id }}</td>
                    <td>{{ req.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td class="text-small">{{ req.model_requested }}</td>
                    <td class="text-small">{{ req.model_mapped }}</td>
                    <td>{{ req.message_count }}</td>
                    <td>{{ req.temperature or '-' }}</td>
                    <td>
                        {% if req.stream %}
                            <span class="badge badge-stream">æ˜¯</span>
                        {% else %}
                            <span class="badge badge-normal">å¦</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if req.response %}
                            {{ req.response.total_tokens or '-' }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if req.response %}
                            {{ "%.2f"|format(req.response.total_latency) }}s
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if req.response %}
                            {% if req.response.status_code == 200 %}
                                <span class="badge badge-success">æˆåŠŸ</span>
                            {% else %}
                                <span class="badge badge-error">é”™è¯¯</span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-normal">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/admin/request/{{ req.request_id }}" class="btn btn-primary">è¯¦æƒ…</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
                <a href="/admin/requests?page={{ page - 1 }}&per_page={{ per_page }}">â† ä¸Šä¸€é¡µ</a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <span class="current">{{ p }}</span>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                    <a href="/admin/requests?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
                {% elif p == 4 or p == total_pages - 3 %}
                    <span>...</span>
                {% endif %}
            {% endfor %}
            
            {% if page < total_pages %}
                <a href="/admin/requests?page={{ page + 1 }}&per_page={{ per_page }}">ä¸‹ä¸€é¡µ â†’</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function changePageSize(size) {
    // åˆ‡æ¢æ¯é¡µæ¡æ•°æ—¶ï¼Œè·³è½¬åˆ°ç¬¬ä¸€é¡µ
    window.location.href = '/admin/requests?page=1&per_page=' + size;
}
</script>
{% endblock %}
