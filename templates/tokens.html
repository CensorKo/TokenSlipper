{% extends "base.html" %}

{% block title %}Token ç®¡ç† - TokenSlipper ç®¡ç†åå°{% endblock %}

{% block page_title %}ğŸ”‘ API Token ç®¡ç†{% endblock %}

{% block content %}
<!-- API è¿æ¥ä¿¡æ¯å¡ç‰‡ -->
<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
        <h2>ğŸ“¡ è¿æ¥ä¿¡æ¯</h2>
        <span style="font-size: 13px; opacity: 0.9;">åœ¨ Cursor æˆ–å…¶ä»–å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ä»¥ä¸‹é…ç½®</span>
    </div>
    <div class="card-body">
        <div class="form-row" style="align-items: center;">
            <div class="form-group" style="flex: 2;">
                <label style="color: rgba(255,255,255,0.8);">API Base URL</label>
                <div class="copy-field">
                    <input type="text" id="api_base_url" value="{{ api_base_url }}" readonly class="copy-input">
                    <button type="button" class="copy-btn" onclick="copyToClipboard('api_base_url')">ğŸ“‹ å¤åˆ¶</button>
                </div>
            </div>
            <div class="form-group" style="flex: 1; display: flex; align-items: center; gap: 10px; margin-bottom: 0;">
                <span style="font-size: 14px; opacity: 0.9;">ğŸ’¡ å°†æ­¤åœ°å€å¡«å…¥ Cursor çš„ OpenAI Base URL</span>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»º Token -->
<div class="card">
    <div class="card-header">
        <h2>â• åˆ›å»º API Token</h2>
        <span class="text-muted" style="font-size: 13px;">ç”Ÿæˆ OpenAI å…¼å®¹æ ¼å¼çš„ Token</span>
    </div>
    <div class="card-body">
        {% if error %}
        <div class="alert alert-error">
            <span>âŒ</span> {{ error }}
        </div>
        {% endif %}
        
        <form method="post" action="/admin/tokens/add">
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="name">ä»¤ç‰Œåç§° *</label>
                    <input type="text" id="name" name="name" required 
                           placeholder="å¦‚: Cursor ä¸“ç”¨"
                           value="{{ form_data.name if form_data else '' }}">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="expires_days">è¿‡æœŸæ—¶é—´</label>
                    <select id="expires_days" name="expires_days">
                        <option value="">æ°¸ä¸è¿‡æœŸ</option>
                        <option value="7">7 å¤©</option>
                        <option value="30">30 å¤©</option>
                        <option value="90">90 å¤©</option>
                        <option value="365">1 å¹´</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label for="description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="description" name="description" 
                           placeholder="å¦‚: ç”¨äº Cursor IDE çš„ API è°ƒç”¨"
                           value="{{ form_data.description if form_data else '' }}">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button type="submit" class="btn btn-primary">åˆ›å»º Token</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Token åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ”‘ API Token åˆ—è¡¨</h2>
        <span class="text-muted" style="font-size: 13px;">ç‚¹å‡»å¤åˆ¶è·å– Tokenï¼Œå¡«å…¥ Cursor çš„ API Key</span>
    </div>
    <div class="card-body">
        {% if tokens %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ä»¤ç‰Œåç§°</th>
                    <th>Token</th>
                    <th>æè¿°</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>è¿‡æœŸæ—¶é—´</th>
                    <th>ä½¿ç”¨æ¬¡æ•°</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for token in tokens %}
                <tr>
                    <td>{{ token.id }}</td>
                    <td><strong>{{ token.name }}</strong></td>
                    <td>
                        <code class="token-code">{{ token.token_key[:20] }}...</code>
                        <button class="btn btn-sm btn-secondary" onclick="copyToken('{{ token.token_key }}')">ğŸ“‹ å¤åˆ¶</button>
                    </td>
                    <td>{{ token.description or '-' }}</td>
                    <td>{{ token.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if token.expires_at %}
                            {{ token.expires_at.strftime('%Y-%m-%d') }}
                        {% else %}
                        <span class="text-muted">æ°¸ä¸è¿‡æœŸ</span>
                        {% endif %}
                    </td>
                    <td>{{ token.use_count }}</td>
                    <td>
                        {% if token.is_active %}
                        <span class="badge badge-success">å¯ç”¨</span>
                        {% else %}
                        <span class="badge badge-error">ç¦ç”¨</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm {{ 'btn-danger' if token.is_active else 'btn-success' }}" 
                                onclick="toggleToken({{ token.id }}, this)">
                            {{ 'ç¦ç”¨' if token.is_active else 'å¯ç”¨' }}
                        </button>
                        <a href="/admin/tokens/{{ token.id }}/delete" class="btn btn-danger btn-sm" 
                           onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ Tokenï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')">åˆ é™¤</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ”‘</div>
            <p>æš‚æ—  API Token</p>
            <p class="text-muted">è¯·åœ¨ä¸Šæ–¹åˆ›å»º Token</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- ä½¿ç”¨è¯´æ˜ -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
    </div>
    <div class="card-body">
        <div class="help-section">
            <h4>ğŸ¯ åœ¨ Cursor ä¸­ä½¿ç”¨</h4>
            <ol>
                <li>æ‰“å¼€ Cursor è®¾ç½® (Settings)</li>
                <li>æ‰¾åˆ° <strong>OpenAI</strong> æˆ– <strong>Models</strong> é…ç½®</li>
                <li>è®¾ç½® <strong>OpenAI Base URL</strong> ä¸ºï¼š<code>{{ api_base_url }}</code></li>
                <li>è®¾ç½® <strong>OpenAI API Key</strong> ä¸ºä¸Šæ–¹åˆ—è¡¨ä¸­å¤åˆ¶çš„ Token</li>
                <li>ä¿å­˜è®¾ç½®ï¼Œå¼€å§‹ä½¿ç”¨</li>
            </ol>
        </div>
        <div class="help-section">
            <h4>ğŸ”§ åœ¨å…¶ä»–å®¢æˆ·ç«¯ä¸­ä½¿ç”¨</h4>
            <p>ä»»ä½•æ”¯æŒ OpenAI API æ ¼å¼çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥ä½¿ç”¨ï¼š</p>
            <ul>
                <li><strong>API Base URL:</strong> <code>{{ api_base_url }}</code></li>
                <li><strong>API Key:</strong> ä»ä¸Šæ–¹åˆ—è¡¨å¤åˆ¶</li>
            </ul>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(element.value).then(() => {
        showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
}

function copyToken(token) {
    navigator.clipboard.writeText(token).then(() => {
        showToast('Token å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
}

async function toggleToken(id, btn) {
    btn.disabled = true;
    btn.textContent = 'å¤„ç†ä¸­...';
    
    try {
        const response = await fetch('/admin/tokens/' + id + '/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Token å·²' + result.status);
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            showToast('æ“ä½œå¤±è´¥');
            btn.disabled = false;
        }
    } catch (error) {
        showToast('è¯·æ±‚å¤±è´¥');
        btn.disabled = false;
    }
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 2000);
}
</script>

<style>
.copy-field {
    display: flex;
    gap: 10px;
}

.copy-input {
    flex: 1;
    background: rgba(255,255,255,0.1) !important;
    color: white !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
}

.copy-input::placeholder {
    color: rgba(255,255,255,0.5);
}

.copy-btn {
    padding: 10px 20px;
    background: white;
    color: #667eea;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.token-code {
    background: #edf2f7;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: 'Consolas', 'Monaco', monospace;
    margin-right: 8px;
}

.help-section {
    margin-bottom: 24px;
}

.help-section:last-child {
    margin-bottom: 0;
}

.help-section h4 {
    color: #2d3748;
    margin-bottom: 12px;
    font-size: 16px;
}

.help-section ol,
.help-section ul {
    margin-left: 20px;
    color: #4a5568;
}

.help-section li {
    margin: 8px 0;
}

.help-section code {
    background: #edf2f7;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
}

.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #2d3748;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s;
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
</style>
{% endblock %}
