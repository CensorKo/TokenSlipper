{% extends "base.html" %}

{% block title %}API å‚å•†ç®¡ç† - TokenSlipper ç®¡ç†åå°{% endblock %}

{% block page_title %}ğŸ¢ API å‚å•†ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>â• æ·»åŠ  API å‚å•†</h2>
        <span class="text-muted" style="font-size: 13px;">æ”¯æŒ OpenAI å…¼å®¹æ ¼å¼çš„ API</span>
    </div>
    <div class="card-body">
        {% if error %}
        <div class="alert alert-error">
            <span>âŒ</span> {{ error }}
        </div>
        {% endif %}
        
        <form method="post" action="/admin/providers/add">
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="name">å‚å•†åç§°</label>
                    <input type="text" id="name" name="name" required 
                           placeholder="å¦‚: Claude API"
                           value="{{ form_data.name if form_data else '' }}">
                </div>
                <div class="form-group" style="flex: 2;">
                    <label for="base_url">API åœ°å€</label>
                    <input type="url" id="base_url" name="base_url" required 
                           placeholder="å¦‚: https://api.anthropic.com/v1"
                           value="{{ form_data.base_url if form_data else '' }}">
                    <span class="help-text">OpenAI å…¼å®¹æ ¼å¼çš„ API åŸºç¡€åœ°å€</span>
                </div>
            </div>
            <div class="form-group">
                <label for="api_key">API Key</label>
                <input type="password" id="api_key" name="api_key" required 
                       placeholder="è¾“å…¥ API Key"
                       value="{{ form_data.api_key if form_data else '' }}">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">æ·»åŠ å‚å•†</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>ğŸ“‹ API å‚å•†åˆ—è¡¨</h2>
        <span class="text-muted" style="font-size: 13px;">ç‚¹å‡»æµ‹è¯•æŒ‰é’®éªŒè¯ API å¯ç”¨æ€§</span>
    </div>
    <div class="card-body">
        {% if providers %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>çŠ¶æ€</th>
                    <th>å‚å•†åç§°</th>
                    <th>API åœ°å€</th>
                    <th>çŠ¶æ€</th>
                    <th>æœ€åæµ‹è¯•</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for provider in providers %}
                <tr>
                    <td>
                        <div class="status-indicator status-{{ provider.test_status }}"></div>
                    </td>
                    <td>
                        <strong>{{ provider.name }}</strong>
                        {% if provider.test_message %}
                        <div class="test-message" title="{{ provider.test_message }}">{{ provider.test_message[:50] }}{% if provider.test_message|length > 50 %}...{% endif %}</div>
                        {% endif %}
                    </td>
                    <td><code class="url-code">{{ provider.base_url }}</code></td>
                    <td>
                        {% if provider.is_active %}
                        <span class="badge badge-success">å¯ç”¨</span>
                        {% else %}
                        <span class="badge badge-error">ç¦ç”¨</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if provider.test_time %}
                        {{ provider.test_time.strftime('%m-%d %H:%M') }}
                        {% else %}
                        <span class="text-muted">æœªæµ‹è¯•</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="testProvider({{ provider.id }})">
                            <span id="test-btn-{{ provider.id }}">ğŸ§ª æµ‹è¯•</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleEditForm({{ provider.id }})">ç¼–è¾‘</button>
                        <a href="/admin/providers/{{ provider.id }}/delete" class="btn btn-danger btn-sm" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤å‚å•†ï¼Ÿ')">åˆ é™¤</a>
                    </td>
                </tr>
                <tr id="edit-form-{{ provider.id }}" class="edit-row" style="display: none;">
                    <td colspan="6">
                        <form method="post" action="/admin/providers/{{ provider.id }}/edit">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <input type="text" value="{{ provider.name }}" disabled title="å‚å•†åç§°ä¸å¯ä¿®æ”¹">
                                </div>
                                <div class="form-group" style="flex: 2;">
                                    <input type="url" name="base_url" value="{{ provider.base_url }}" required placeholder="API åœ°å€">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <input type="password" name="api_key" value="{{ provider.api_key }}" required placeholder="API Key">
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                                    <label class="checkbox-wrapper">
                                        <input type="checkbox" name="is_active" {% if provider.is_active %}checked{% endif %}>
                                        <span>å¯ç”¨</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary btn-sm">ä¿å­˜</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEditForm({{ provider.id }})">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </form>
                    </td>
                </tr>
                <tr id="test-result-{{ provider.id }}" class="test-result-row" style="display: none;">
                    <td colspan="6">
                        <div id="test-content-{{ provider.id }}" class="test-content"></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ¢</div>
            <p>æš‚æ—  API å‚å•†</p>
            <p class="text-muted">è¯·åœ¨ä¸Šæ–¹æ·»åŠ  API å‚å•†</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleEditForm(id) {
    const form = document.getElementById('edit-form-' + id);
    if (form.style.display === 'none') {
        document.querySelectorAll('.edit-row').forEach(el => {
            el.style.display = 'none';
        });
        form.style.display = 'table-row';
    } else {
        form.style.display = 'none';
    }
}

async function testProvider(id) {
    const btn = document.getElementById('test-btn-' + id);
    const resultRow = document.getElementById('test-result-' + id);
    const contentDiv = document.getElementById('test-content-' + id);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    btn.innerHTML = 'â³ æµ‹è¯•ä¸­...';
    btn.disabled = true;
    resultRow.style.display = 'none';
    
    try {
        const response = await fetch('/admin/providers/' + id + '/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        // æ„å»ºæµ‹è¯•ç»“æœ HTML
        let html = '<div class="test-result-content">';
        html += '<h4>ğŸ§ª æµ‹è¯•ç»“æœ - ' + result.provider_name + '</h4>';
        html += '<div class="test-summary ' + result.status + '">' + result.message + '</div>';
        
        // éæµå¼æµ‹è¯•ç»“æœ
        if (result.tests.non_stream) {
            const ns = result.tests.non_stream;
            html += '<div class="test-detail">';
            html += '<h5>ğŸ“¤ éæµå¼è¯·æ±‚</h5>';
            if (ns.status === 'success') {
                html += '<span class="badge badge-success">âœ“ æˆåŠŸ</span>';
                html += '<p>çŠ¶æ€ç : ' + ns.status_code + '</p>';
                html += '<p>æ¨¡å‹: ' + ns.model + '</p>';
                html += '<p>å›å¤: ' + ns.content + '</p>';
            } else {
                html += '<span class="badge badge-error">âœ— å¤±è´¥</span>';
                html += '<p>çŠ¶æ€ç : ' + (ns.status_code || 'N/A') + '</p>';
                html += '<p>é”™è¯¯: ' + (ns.error || 'æœªçŸ¥é”™è¯¯') + '</p>';
            }
            html += '</div>';
        }
        
        // æµå¼æµ‹è¯•ç»“æœ
        if (result.tests.stream) {
            const s = result.tests.stream;
            html += '<div class="test-detail">';
            html += '<h5>ğŸ“¡ æµå¼è¯·æ±‚</h5>';
            if (s.status === 'success') {
                html += '<span class="badge badge-success">âœ“ æˆåŠŸ</span>';
                html += '<p>çŠ¶æ€ç : ' + s.status_code + '</p>';
                html += '<p>æ”¶åˆ° ' + s.chunks_received + ' ä¸ªæ•°æ®å—</p>';
            } else {
                html += '<span class="badge badge-error">âœ— å¤±è´¥</span>';
                html += '<p>çŠ¶æ€ç : ' + (s.status_code || 'N/A') + '</p>';
                html += '<p>é”™è¯¯: ' + (s.error || 'æœªçŸ¥é”™è¯¯') + '</p>';
            }
            html += '</div>';
        }
        
        html += '</div>';
        
        contentDiv.innerHTML = html;
        resultRow.style.display = 'table-row';
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        setTimeout(() => {
            location.reload();
        }, 3000);
        
    } catch (error) {
        contentDiv.innerHTML = '<div class="alert alert-error">æµ‹è¯•è¯·æ±‚å¤±è´¥: ' + error.message + '</div>';
        resultRow.style.display = 'table-row';
    } finally {
        btn.innerHTML = 'ğŸ§ª æµ‹è¯•';
        btn.disabled = false;
    }
}
</script>

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.status-success {
    background: #48bb78;
    box-shadow: 0 0 8px #48bb78;
}

.status-failed {
    background: #f56565;
    box-shadow: 0 0 8px #f56565;
}

.status-unknown {
    background: #a0aec0;
}

.status-partial {
    background: #ed8936;
    box-shadow: 0 0 8px #ed8936;
}

.url-code {
    font-size: 12px;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline-block;
}

.test-message {
    font-size: 12px;
    color: #718096;
    margin-top: 4px;
}

.edit-row {
    background: #f7fafc;
}

.edit-row td {
    padding: 16px;
}

.test-result-row {
    background: #f7fafc;
}

.test-result-row td {
    padding: 0;
}

.test-content {
    padding: 20px;
}

.test-result-content {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.test-result-content h4 {
    margin-bottom: 16px;
    color: #1a202c;
}

.test-summary {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-weight: 500;
}

.test-summary.success {
    background: #c6f6d5;
    color: #22543d;
}

.test-summary.failed {
    background: #fed7d7;
    color: #742a2a;
}

.test-summary.partial {
    background: #fefcbf;
    color: #744210;
}

.test-detail {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 12px;
}

.test-detail h5 {
    margin-bottom: 12px;
    color: #4a5568;
}

.test-detail p {
    margin: 4px 0;
    font-size: 13px;
    color: #4a5568;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
}

.checkbox-wrapper input[type="checkbox"] {
    width: auto;
    margin: 0;
}
</style>
{% endblock %}
