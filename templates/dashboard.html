{% extends "base.html" %}

{% block title %}æ¦‚è§ˆ - TokenSlipper ç®¡ç†åå°{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_requests }}</div>
        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_messages }}</div>
        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_tokens or 0 }}</div>
        <div class="stat-label">æ€» Token æ¶ˆè€—</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.avg_latency }}s</div>
        <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
    </div>
</div>

<!-- æœ€è¿‘è¯·æ±‚ -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“‹ æœ€è¿‘è¯·æ±‚</h2>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>æ¨¡å‹</th>
                    <th>æ¶ˆæ¯æ•°</th>
                    <th>Tokens</th>
                    <th>è€—æ—¶</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for req in recent_requests %}
                <tr>
                    <td>{{ req.timestamp.strftime('%m-%d %H:%M:%S') }}</td>
                    <td>
                        <span class="text-small">{{ req.model_requested }}</span>
                        {% if req.model_requested != req.model_mapped %}
                        <br><span class="text-muted text-small">â†’ {{ req.model_mapped }}</span>
                        {% endif %}
                    </td>
                    <td>{{ req.message_count }}</td>
                    <td>
                        {% if req.response %}
                            {{ req.response.total_tokens or '-' }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if req.response %}
                            {{ "%.2f"|format(req.response.total_latency) }}s
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if req.response %}
                            {% if req.response.status_code == 200 %}
                                <span class="badge badge-success">æˆåŠŸ</span>
                            {% else %}
                                <span class="badge badge-error">é”™è¯¯ {{ req.response.status_code }}</span>
                            {% endif %}
                            {% if req.response.is_stream %}
                                <span class="badge badge-stream">Stream</span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-normal">å¤„ç†ä¸­</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/admin/request/{{ req.request_id }}" class="btn btn-primary">æŸ¥çœ‹è¯¦æƒ…</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 20px; text-align: center;">
            <a href="/admin/requests?per_page=20" class="btn btn-secondary">æŸ¥çœ‹å…¨éƒ¨è¯·æ±‚ â†’</a>
        </div>
    </div>
</div>

<!-- æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡ -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ¤– æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡</h2>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>æ¨¡å‹</th>
                    <th>è¯·æ±‚æ¬¡æ•°</th>
                    <th>å æ¯”</th>
                </tr>
            </thead>
            <tbody>
                {% for model in model_stats %}
                <tr>
                    <td>{{ model.model_mapped or 'Unknown' }}</td>
                    <td>{{ model.count }}</td>
                    <td>{{ "%.1f"|format(model.count / stats.total_requests * 100) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
